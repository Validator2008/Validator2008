name: Close Old Pull Requests

on:
  schedule:
    # Run once a week on Monday at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch: # Allow manual triggering

permissions:
  pull-requests: write
  issues: write

jobs:
  close-old-prs:
    runs-on: ubuntu-latest
    steps:
      - name: Close old pull requests
        uses: actions/github-script@v7
        with:
          script: |
            const twoYearsAgo = new Date();
            twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2);
            
            console.log(`Looking for PRs created before: ${twoYearsAgo.toISOString()}`);
            
            // Fetch all open pull requests using pagination
            const pullRequests = await github.paginate(github.rest.pulls.list, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100,
              sort: 'created',
              direction: 'asc'
            });
            
            console.log(`Found ${pullRequests.length} open pull requests`);
            
            let closedCount = 0;
            for (const pr of pullRequests) {
              const createdAt = new Date(pr.created_at);
              
              if (createdAt < twoYearsAgo) {
                console.log(`Closing PR #${pr.number}: "${pr.title}" (created ${pr.created_at})`);
                
                // Add a comment explaining why the PR is being closed
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: 'ðŸ¤– This pull request has been automatically closed because it is older than 2 years. If this work is still relevant, please feel free to open a new pull request with updated changes.'
                });
                
                // Close the pull request
                await github.rest.pulls.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  state: 'closed'
                });
                
                closedCount++;
              }
            }
            
            console.log(`Closed ${closedCount} pull request(s) older than 2 years`);
